<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8">

    <title>WebGL Ocean</title>
    <style>
      body {
          margin: 0;
          font-family: monospace;
      }
      canvas {
          display: block;
          width: 100vw;
          height: 100vh;
      }
      #b {
        position: absolute;
        top: 10px;
        width: 100%;
        text-align: center;
        z-index: 2;
      }
    </style>
  </head>
  <body>
    <canvas id="c"></canvas>
  </body>
  <script id="vs" type="notjs">
#version 300 es

precision mediump float;

in vec4 position;
in vec2 texcoord;
    
out vec2 texCoordV;
    
void main() {
  
  gl_Position = position;
  texCoordV = texcoord;
}

  </script>
  <script id="h0kfs" type="notjs">
#version 300 es

precision mediump float;

layout (location = 0) out vec4 h0k; 

void main(void) {

	h0k = vec4(0.0, 1.0, 1.0, 1.0);

}
  </script>

  <script id="drawTex" type="notjs">
	#version 300 es
  	precision mediump float;
  	uniform sampler2D tex;
	  in vec2 texCoordV;
  	out vec4 outColor;

  	void main() {
    	vec4 colors;
    	colors = texture(tex, texCoordV * 512.0);
      if(colors.y != 0.0) outColor = vec4(1.0, 0.0, 0.0, 1.0);
      else outColor = vec4(0.0, 1.0, 0.0, 1.0);
		  //outColor = colors;
  	}
  </script>

  <script type="module">
    import * as twgl from './twgl-full.module.js';
    const gl = document.querySelector("#c").getContext("webgl2");
	  const ext = gl.getExtension("EXT_color_buffer_float");
    gl.getExtension('EXT_color_buffer_float');
    gl.getExtension('EXT_float_blend');
    gl.getExtension('OES_texture_float_linear');

	//h0k
	const programInfo = twgl.createProgramInfo(gl, ["vs", "h0kfs"]);

  const width = 512;
  const height = 512;
  const targetTexture = gl.createTexture();
	gl.bindTexture(gl.TEXTURE_2D, targetTexture);

  const level = 0;
	gl.texImage2D(gl.TEXTURE_2D, level, gl.RGBA32F, width, height, 0, 
                gl.RGBA, gl.FLOAT, null);
  
  gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
	gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
	gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
	gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);

	const fb = gl.createFramebuffer();
  gl.bindFramebuffer(gl.FRAMEBUFFER, fb);

	gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, targetTexture, level);
	
  //h0k
  gl.useProgram(programInfo.program);

	gl.viewport(0, 0, width, height);

  const arrays = {
     position: [-1, -1, 0, 1, -1, 0, -1, 1, 0, -1, 1, 0, 1, -1, 0, 1, 1, 0],
     texcoord: [0, 0, 1, 0, 0, 1, 0, 1, 1, 0, 1, 1],
  };

  const bufferInfo = twgl.createBufferInfoFromArrays(gl, arrays);

  console.log(gl.checkFramebufferStatus(gl.FRAMEBUFFER) == gl.FRAMEBUFFER_COMPLETE)
    
  twgl.setBuffersAndAttributes(gl, programInfo, bufferInfo);
  twgl.drawBufferInfo(gl, bufferInfo);

  //debug kinda
  const prgInfo2 = twgl.createProgramInfo(gl, ["vs", "drawTex"]);
  gl.useProgram(prgInfo2.program);

  gl.bindFramebuffer(gl.FRAMEBUFFER, null);

  twgl.resizeCanvasToDisplaySize(gl.canvas);
  gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);

	const uniforms2={
		tex: targetTexture,
	}

	function render(){
		
		twgl.setUniforms(prgInfo2, uniforms2);
   	twgl.setBuffersAndAttributes(gl, prgInfo2, bufferInfo);
   	twgl.drawBufferInfo(gl, bufferInfo);

		requestAnimationFrame(render);
	}
	requestAnimationFrame(render);

	
  </script>
</html>