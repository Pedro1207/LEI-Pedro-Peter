<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf8" />

    <title>WebGL Ocean</title>
    <style>
      body {
        margin: 0;
        font-family: monospace;
      }
      canvas {
        display: block;
        width: 100vw;
        height: 100vh;
      }
      #b {
        position: absolute;
        top: 10px;
        width: 100%;
        text-align: center;
        z-index: 2;
      }
    </style>
  </head>
  <body>
    <canvas id="c"></canvas>
  </body>
  <script id="vs" type="notjs">
    #version 300 es

    precision mediump float;

    in vec4 position;
    uniform mat4 u_worldViewProjection;

    void main() {
      gl_Position = u_worldViewProjection * position;
    }
  </script>
  
  <script id="drawTex" type="notjs">
    #version 300 es
     	precision mediump float;
         out vec4 color;
     	void main() {
            color = vec4(1.0, 0.0, 0.0, 1.0);
     	}
  </script>

  <script type="module">
    import * as twgl from "./twgl-full.module.js";
    const gl = document.querySelector("#c").getContext("webgl2");
    const m4 = twgl.m4;
    gl.getExtension("EXT_color_buffer_float");
    gl.getExtension("EXT_float_blend");
    gl.getExtension("OES_texture_float_linear");

    const oceanprogram = twgl.createProgramInfo(gl, [
      "vs",
      "drawTex",
    ]);

    gl.useProgram(oceanprogram.program);

    var mapSize = 256;

    twgl.resizeCanvasToDisplaySize(gl.canvas);
    gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);

      var oceanGrid = []

      for (var i = 0; i < mapSize - 1; i++) {
        for (var j = 0; j < mapSize - 1; j++) {
          oceanGrid.push(j - mapSize/2);
          oceanGrid.push(0);
          oceanGrid.push(i - mapSize/2);
          
          oceanGrid.push(j - mapSize/2);
          oceanGrid.push(0);
          oceanGrid.push(i+1 - mapSize/2);

          oceanGrid.push(j+1 - mapSize/2);
          oceanGrid.push(0);
          oceanGrid.push(i - mapSize/2);

          oceanGrid.push(j+1 - mapSize/2);
          oceanGrid.push(0);
          oceanGrid.push(i - mapSize/2);

          oceanGrid.push(j - mapSize/2);
          oceanGrid.push(0);
          oceanGrid.push(i+1 - mapSize/2);

          oceanGrid.push(j+1 - mapSize/2);
          oceanGrid.push(0);
          oceanGrid.push(i+1 - mapSize/2);
        }
      }

      const oceanUniforms = {
      };

      const fov = 30 * Math.PI / 180;
      const aspect = gl.canvas.clientWidth / gl.canvas.clientHeight;
      const zNear = 1;
      const zFar = 1000;
      const projection = m4.perspective(fov, aspect, zNear, zFar);
      const eye = [100, 20, 100];
      const target = [0, 0, 0];
      const up = [0, 1, 0];

      const camera = m4.lookAt(eye, target, up);
      const view = m4.inverse(camera);
      const viewProjection = m4.multiply(projection, view);
      const world = m4.identity();

      oceanUniforms.u_viewInverse = camera;
      oceanUniforms.u_world = world;
      oceanUniforms.u_worldInverseTranspose = m4.transpose(m4.inverse(world));
      oceanUniforms.u_worldViewProjection = m4.multiply(viewProjection, world);

      const oceanArrays = {
        position: oceanGrid,
      };
      const oceanBufferInfo = twgl.createBufferInfoFromArrays(gl, oceanArrays);

      function render() {

      twgl.setUniforms(oceanprogram, oceanUniforms);
      twgl.setBuffersAndAttributes(gl, oceanprogram, oceanBufferInfo);
      twgl.drawBufferInfo(gl, oceanBufferInfo);

      requestAnimationFrame(render);
	  console.log("loop");
    }
    requestAnimationFrame(render);
  </script>
</html>
